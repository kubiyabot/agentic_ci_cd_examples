name: Vulnerability Scanner

on:
  push:
    paths:
      - 'vulnerability-scanner/**'
  pull_request:
    paths:
      - 'vulnerability-scanner/**'
  workflow_dispatch:

env:
  WORKING_DIR: vulnerability-scanner

jobs:
  # Baseline: Traditional vulnerability scanning without intelligence
  baseline-scan:
    name: Baseline Vulnerability Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Run Trivy filesystem scan
        run: |
          trivy fs . --format json --output trivy-results.json || true
          trivy fs . --severity HIGH,CRITICAL --format table

      - name: Run unit tests
        run: npm test

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: baseline-trivy-results
          path: ${{ env.WORKING_DIR }}/trivy-results.json

  # Intelligent: Kubiya agentic vulnerability scanning with memory and PR creation
  intelligent-scan:
    name: Intelligent Vulnerability Scan (Kubiya)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Security Scanning Tools
        run: |
          # Install Trivy
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

          # Install additional tools the agent can leverage
          npm install -g snyk || true
          pip install safety || true

          # Verify installations
          echo "=== Installed Security Tools ==="
          trivy --version
          which snyk && snyk --version || echo "Snyk not configured (needs auth)"
          which safety && safety --version || echo "Safety not available"

      - name: Install Kubiya CLI and Run Intelligent Vulnerability Scan
        env:
          KUBIYA_API_KEY: ${{ secrets.KUBIYA_API_KEY }}
          KUBIYA_NON_INTERACTIVE: "true"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install Kubiya CLI
          curl -fsSL https://raw.githubusercontent.com/kubiyabot/cli/main/install.sh | bash
          export PATH="$HOME/.kubiya/bin:$PATH"

          # Run intelligent vulnerability scan
          kubiya exec "
          ** YOU ARE RUNNING FROM WITHIN CI/CD AUTOMATION - NO USER INTERACTION INVOLVED - EXECUTE AWAY EVEN COMPLEX PLANS **

          You are an intelligent security agent with organizational memory. Your mission is to scan for vulnerabilities, analyze findings, apply historical knowledge, suggest fixes, and optionally create a PR with patches.

          REPOSITORY CONTEXT:
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Event: ${{ github.event_name }}

          AVAILABLE TOOLS:
          - trivy: Filesystem and dependency vulnerability scanner (INSTALLED)
          - npm audit: Node.js dependency audit
          - git/gh: Git operations and GitHub CLI for PR creation

          ============================================================
          PHASE 1 - RECALL SECURITY HISTORY
          ============================================================
          Before scanning, recall organizational memory for:
          - Previous vulnerability findings in this repository
          - Known false positives to ignore
          - Successful remediation patterns
          - Security policies and thresholds

          Use: recall_memory('vulnerability scan history for this repository')
          Use: recall_memory('security remediation patterns')

          ============================================================
          PHASE 2 - EXECUTE VULNERABILITY SCAN
          ============================================================
          Run comprehensive security scans:

          1. Run Trivy filesystem scan:
             trivy fs . --format json --output trivy-results.json
             trivy fs . --severity HIGH,CRITICAL --format table

          2. Run npm audit for additional coverage:
             npm audit --json > npm-audit.json || true

          3. Check for secrets/credentials (basic patterns):
             grep -r -n -E '(password|secret|api_key|token)\\s*=\\s*[\"'\\'][^\"'\\']' --include='*.js' --include='*.ts' --include='*.json' . || echo 'No hardcoded secrets pattern found'

          ============================================================
          PHASE 3 - ANALYZE FINDINGS
          ============================================================
          Parse and analyze the scan results:

          1. Read trivy-results.json and categorize findings:
             - CRITICAL: Immediate action required
             - HIGH: Should be fixed before merge
             - MEDIUM: Plan for remediation
             - LOW: Track for future

          2. For each vulnerability found:
             - Check if it has a known fix version
             - Determine if it's a direct or transitive dependency
             - Assess exploitability based on code usage

          3. Calculate security metrics:
             - Total vulnerabilities by severity
             - Risk score (CRITICAL=10, HIGH=7, MEDIUM=4, LOW=1)
             - Percentage with available fixes

          4. Compare with recalled history:
             - Identify NEW vulnerabilities (not seen before)
             - Identify RECURRING issues
             - Check for REGRESSIONS (previously fixed, now back)

          ============================================================
          PHASE 4 - GENERATE REMEDIATION PLAN
          ============================================================
          For fixable vulnerabilities:

          1. Generate specific fix commands:
             - npm install package@fixed-version
             - Group related updates together

          2. Prioritize fixes by:
             - Severity (CRITICAL first)
             - Ease of fix (has fix version vs needs workaround)
             - Impact scope (direct vs transitive)

          3. Identify code changes needed:
             - For vulnerable code patterns in src/
             - Suggest secure alternatives

          ============================================================
          PHASE 5 - CREATE FIX PR (if applicable)
          ============================================================
          If CRITICAL or HIGH vulnerabilities with fixes are found AND this is not already a PR:

          1. Create a new branch:
             git checkout -b security/fix-vulnerabilities-\$(date +%Y%m%d)

          2. Apply dependency fixes:
             - Update package.json with fixed versions
             - Run npm install to update package-lock.json

          3. Commit changes:
             git add package.json package-lock.json
             git commit -m 'fix(security): update vulnerable dependencies

             Fixes:
             - [List CVEs addressed]

             Scan date: \$(date -I)
             '

          4. Push and create PR:
             git push -u origin HEAD
             gh pr create --title 'Security: Fix vulnerable dependencies' \\
               --body 'Automated security fix PR

               ## Vulnerabilities Fixed
               [List from analysis]

               ## Risk Reduction
               [Before/after risk score]

               ## Testing
               - [ ] All tests pass
               - [ ] No breaking changes

               Generated by Kubiya Security Agent'

          ============================================================
          PHASE 6 - STORE LEARNINGS
          ============================================================
          Store findings to organizational memory for future reference:

          store_memory({
            dataset: 'vulnerability-scan-history',
            content: 'Vulnerability scan results for [repo] on [date]',
            metadata: {
              repository: '${{ github.repository }}',
              branch: '${{ github.ref_name }}',
              commit: '${{ github.sha }}',
              scan_date: '[ISO date]',
              total_vulnerabilities: [count],
              critical_count: [count],
              high_count: [count],
              risk_score: [score],
              fixes_applied: [list of CVEs fixed],
              pr_created: [true/false],
              pr_url: '[if created]'
            }
          })

          If you discovered new remediation patterns or workarounds:

          store_memory({
            dataset: 'security-remediation-patterns',
            content: 'Description of the fix pattern',
            metadata: {
              pattern_type: 'DEPENDENCY_UPDATE|CODE_FIX|CONFIGURATION',
              vulnerability_type: '[type]',
              package: '[affected package]',
              solution: '[how to fix]',
              effectiveness: 'high|medium|low'
            }
          })

          ============================================================
          PHASE 7 - REPORT SUMMARY
          ============================================================
          Provide a clear summary including:

          1. SCAN RESULTS:
             - Total vulnerabilities found
             - Breakdown by severity
             - Risk score

          2. HISTORICAL CONTEXT:
             - New vs recurring issues
             - Trend (improving/degrading/stable)

          3. ACTIONS TAKEN:
             - Dependencies updated
             - PR created (if applicable)
             - Learnings stored

          4. RECOMMENDATIONS:
             - Immediate actions needed
             - Security best practices
             - Follow-up items

          5. CI DECISION:
             - PASS: No CRITICAL, <= 5 HIGH, risk score < 50
             - WARN: Some HIGH vulnerabilities but manageable
             - FAIL: CRITICAL vulnerabilities or risk score > 100
          " --local --cwd . --yes

      - name: Run unit tests
        run: npm test

      - name: Upload intelligent scan results
        uses: actions/upload-artifact@v4
        with:
          name: intelligent-scan-results
          path: |
            ${{ env.WORKING_DIR }}/trivy-results.json
            ${{ env.WORKING_DIR }}/npm-audit.json
        if: always()
