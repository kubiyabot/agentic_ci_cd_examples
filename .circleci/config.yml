version: 2.1
setup: true

# =============================================================================
# Setup Phase - Path Filtering for Conditional Pipeline Triggers
# =============================================================================
#
# This config detects which folders changed and triggers the appropriate
# workflows in continue_config.yml
#
# Prerequisites:
# 1. Enable "Dynamic config using setup workflows" in Project Settings → Advanced
# 2. Create 'kubiya-secrets' context with KUBIYA_API_KEY (and optional KUBIYA_AGENT_UUID)
#
# Behavior:
# - Changes in fleaky-tests-circleci/ → runs flaky test workflows
# - Changes in smart-test-selection/ → runs smart selection workflows
# - Changes in both → runs both workflows
# - Changes in root files only → no workflows run
# =============================================================================

orbs:
  path-filtering: circleci/path-filtering@3.0.0

# Custom executor with Python 3.11 (default cimg/base has Python 3.8 which is too old)
executors:
  python311:
    docker:
      - image: cimg/python:3.11

workflows:
  setup:
    jobs:
      - path-filtering/filter:
          executor: python311
          base-revision: main
          config-path: .circleci/continue_config.yml
          mapping: |
            fleaky-tests-circleci/.* run-flaky-tests true
            smart-test-selection/.* run-smart-selection true
