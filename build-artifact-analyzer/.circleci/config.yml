version: 2.1

orbs:
  node: circleci/node@5.1.0

# ============================================================
# BUILD ARTIFACT ANALYZER
# Demonstrates Kubiya Cognitive Memory for build data ingestion
# and trend analysis across builds
# ============================================================

# Environment variables for memory datasets (set in CircleCI context or project settings)
# KUBIYA_DATASET_BUILD_HISTORY - Dataset for build history (default: "default")
# KUBIYA_DATASET_COVERAGE - Dataset for coverage reports (default: "default")
# KUBIYA_DATASET_TRENDS - Dataset for trend analysis (default: "default")
# KUBIYA_DATASET_ALERTS - Dataset for alerts (default: "default")

executors:
  node-executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project
    environment:
      KUBIYA_DATASET_BUILD_HISTORY: ${KUBIYA_DATASET_BUILD_HISTORY:-default}
      KUBIYA_DATASET_COVERAGE: ${KUBIYA_DATASET_COVERAGE:-default}
      KUBIYA_DATASET_TRENDS: ${KUBIYA_DATASET_TRENDS:-default}
      KUBIYA_DATASET_ALERTS: ${KUBIYA_DATASET_ALERTS:-default}

commands:
  install-kubiya-cli:
    description: Install Kubiya CLI
    steps:
      - run:
          name: Install Kubiya CLI
          command: |
            curl -fsSL https://raw.githubusercontent.com/kubiyabot/cli/main/install.sh | bash
            echo 'export PATH="$HOME/.kubiya/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

  recall-build-history:
    description: Recall previous build metrics from memory
    steps:
      - run:
          name: Recall Build History
          command: |
            echo "=== Recalling Build History from Memory ==="

            # Recall recent builds for baseline comparison
            BUILD_HISTORY=$(kubiya memory recall "build history for ${CIRCLE_PROJECT_REPONAME}" \
              --top-k 10 --output json 2>/dev/null || echo "[]")

            # Recall known performance baselines
            BASELINES=$(kubiya memory recall "performance baselines for ${CIRCLE_PROJECT_REPONAME}" \
              --top-k 5 --output json 2>/dev/null || echo "{}")

            # Save to environment
            echo "export BUILD_HISTORY='$BUILD_HISTORY'" >> $BASH_ENV
            echo "export BASELINES='$BASELINES'" >> $BASH_ENV

            echo "Recalled build history and baselines from memory"

  store-build-metrics:
    description: Store build metrics to memory
    steps:
      - run:
          name: Ingest Build Artifacts to Memory
          command: |
            echo "=== Ingesting Build Artifacts ==="

            # Use environment variables with default fallbacks
            DATASET_BUILD_HISTORY="${KUBIYA_DATASET_BUILD_HISTORY:-default}"
            DATASET_ALERTS="${KUBIYA_DATASET_ALERTS:-default}"

            # Run analysis and store via agent
            kubiya exec "
              You are a build artifact analyzer with memory capabilities.

              TASK: Analyze and ingest build results

              1. Read artifacts/test-results.json if it exists
              2. Read artifacts/coverage/coverage-summary.json if it exists

              3. Calculate key metrics:
                 - Total test duration
                 - Pass/fail counts
                 - Coverage percentages
                 - Slow test count

              4. Compare to historical baselines:
                 PREVIOUS BUILD DATA:
                 $BUILD_HISTORY

                 BASELINES:
                 $BASELINES

              5. Store the build record:
                 store_memory({
                   dataset: '${DATASET_BUILD_HISTORY}',
                   content: 'Build #${CIRCLE_BUILD_NUM} results for ${CIRCLE_PROJECT_REPONAME}',
                   metadata: {
                     repository: '${CIRCLE_PROJECT_REPONAME}',
                     branch: '${CIRCLE_BRANCH}',
                     commit: '${CIRCLE_SHA1}',
                     buildNum: '${CIRCLE_BUILD_NUM}',
                     buildUrl: '${CIRCLE_BUILD_URL}',
                     totalDuration: '[calculated]',
                     testsRun: '[from results]',
                     testsPassed: '[from results]',
                     testsFailed: '[from results]',
                     coverage: '[from coverage]',
                     status: 'success|regression|improvement',
                     timestamp: '$(date -u +%Y-%m-%dT%H:%M:%SZ)'
                   }
                 })

              6. If performance regression detected (>50% slower):
                 store_memory({
                   dataset: '${DATASET_ALERTS}',
                   content: 'Performance regression in build #${CIRCLE_BUILD_NUM}',
                   metadata: {
                     type: 'PERFORMANCE_REGRESSION',
                     severity: 'high',
                     details: '[what regressed]'
                   }
                 })
            " --local --cwd . --yes

  upload-coverage-artifacts:
    description: Upload coverage reports to memory dataset
    steps:
      - run:
          name: Upload Coverage to Memory
          command: |
            if [ -d "artifacts/coverage" ]; then
              echo "=== Uploading Coverage Reports ==="

              # Use environment variable with default fallback
              DATASET_COVERAGE="${KUBIYA_DATASET_COVERAGE:-default}"

              kubiya memory dataset upload "${DATASET_COVERAGE}" ./artifacts/coverage/ \
                --title "Coverage Report: Build #${CIRCLE_BUILD_NUM}" \
                --tags "coverage,${CIRCLE_BRANCH},${CIRCLE_PROJECT_REPONAME}" \
                2>/dev/null || echo "Coverage upload skipped (no dataset or CLI issue)"
            fi

jobs:
  # ============================================================
  # BASELINE: Standard build without intelligence
  # ============================================================
  build-baseline:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run Tests with Coverage
          command: npm run test:coverage -- --json --outputFile=artifacts/test-results.json
      - store_test_results:
          path: artifacts/coverage
      - store_artifacts:
          path: artifacts

  # ============================================================
  # INTELLIGENT: Build with artifact ingestion
  # ============================================================
  build-with-ingestion:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - install-kubiya-cli

      # Phase 1: Recall historical data
      - recall-build-history

      # Phase 2: Run tests
      - run:
          name: Run Tests with Coverage
          command: |
            npm run test:coverage -- --json --outputFile=artifacts/test-results.json

      # Phase 3: Analyze and compare
      - run:
          name: Analyze Build Against Baseline
          command: |
            kubiya exec "
              HISTORICAL DATA:
              $BUILD_HISTORY

              PERFORMANCE BASELINES:
              $BASELINES

              TASK: Analyze current build

              1. Read artifacts/test-results.json
              2. Compare metrics to historical data:
                 - Is this build slower than average?
                 - Is coverage lower than baseline?
                 - Are there more failures than usual?

              3. Report findings:
                 - Status: IMPROVEMENT / STABLE / REGRESSION
                 - Key changes from baseline
                 - Recommendations if any
            " --local --cwd . --yes

      # Phase 4: Store metrics
      - store-build-metrics

      # Phase 5: Upload artifacts
      - upload-coverage-artifacts

      - store_test_results:
          path: artifacts/coverage
      - store_artifacts:
          path: artifacts

  # ============================================================
  # TREND ANALYSIS: Analyze patterns across builds
  # ============================================================
  trend-analysis:
    executor: node-executor
    steps:
      - checkout
      - install-kubiya-cli

      - run:
          name: Analyze Build Trends
          command: |
            # Use environment variables with default fallbacks
            DATASET_TRENDS="${KUBIYA_DATASET_TRENDS:-default}"
            DATASET_ALERTS="${KUBIYA_DATASET_ALERTS:-default}"

            kubiya exec "
              You are a CI trend analyst with memory capabilities.

              TASK: Analyze build trends for ${CIRCLE_PROJECT_REPONAME}

              1. Recall recent build history:
                 recall_memory('build history for ${CIRCLE_PROJECT_REPONAME}')

              2. Recall all performance data:
                 recall_memory('performance baselines for ${CIRCLE_PROJECT_REPONAME}')
                 recall_memory('test duration trends')

              3. Analyze trends:
                 - Build duration: increasing, stable, or decreasing?
                 - Coverage: improving or declining?
                 - Failure rate: getting better or worse?
                 - Flaky test count: trending up or down?

              4. Identify patterns:
                 - Which modules are getting slower?
                 - Which tests fail most often?
                 - What times of day have most failures?

              5. Store trend analysis:
                 store_memory({
                   dataset: '${DATASET_TRENDS}',
                   content: 'Weekly trend analysis for ${CIRCLE_PROJECT_REPONAME}',
                   metadata: {
                     repository: '${CIRCLE_PROJECT_REPONAME}',
                     period: 'weekly',
                     durationTrend: 'increasing|stable|decreasing',
                     coverageTrend: 'improving|stable|declining',
                     failureTrend: 'improving|stable|worsening',
                     recommendations: ['list of actions'],
                     timestamp: '$(date -u +%Y-%m-%dT%H:%M:%SZ)'
                   }
                 })

              6. If concerning trends detected:
                 store_memory({
                   dataset: '${DATASET_ALERTS}',
                   content: 'Trend alert for ${CIRCLE_PROJECT_REPONAME}',
                   metadata: {
                     alertType: '[type]',
                     severity: 'high|medium|low',
                     details: '[explanation]',
                     action: '[recommended action]'
                   }
                 })
            " --local --cwd . --yes

  # ============================================================
  # CLI INGESTION: Direct CLI-based artifact storage
  # ============================================================
  cli-direct-ingestion:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - install-kubiya-cli

      - run:
          name: Run Tests
          command: npm run test:json

      - run:
          name: Direct CLI Artifact Ingestion
          command: |
            echo "=== Direct CLI Artifact Ingestion ==="

            # Use environment variable with default fallback
            DATASET_BUILD_HISTORY="${KUBIYA_DATASET_BUILD_HISTORY:-default}"

            # Parse test results
            TESTS_RUN=$(jq '.numTotalTests // 0' artifacts/test-results.json 2>/dev/null || echo "0")
            TESTS_PASSED=$(jq '.numPassedTests // 0' artifacts/test-results.json 2>/dev/null || echo "0")
            TESTS_FAILED=$(jq '.numFailedTests // 0' artifacts/test-results.json 2>/dev/null || echo "0")

            # Store via CLI
            kubiya memory store \
              --title "Build #${CIRCLE_BUILD_NUM}: ${CIRCLE_PROJECT_REPONAME}" \
              --content "Test Results Summary
            Repository: ${CIRCLE_PROJECT_REPONAME}
            Branch: ${CIRCLE_BRANCH}
            Commit: ${CIRCLE_SHA1}

            Results:
            - Tests Run: $TESTS_RUN
            - Passed: $TESTS_PASSED
            - Failed: $TESTS_FAILED

            Build URL: ${CIRCLE_BUILD_URL}" \
              --dataset-id "${DATASET_BUILD_HISTORY}" \
              --tags "build,${CIRCLE_BRANCH},${CIRCLE_PROJECT_REPONAME}" \
              2>/dev/null || echo "Memory store skipped"

            echo "Build metrics stored to memory"

      - store_artifacts:
          path: artifacts

workflows:
  version: 2

  # Baseline - no intelligence
  baseline:
    jobs:
      - build-baseline

  # Intelligent build with ingestion
  intelligent-build:
    jobs:
      - build-with-ingestion:
          context: kubiya-secrets

  # Weekly trend analysis
  weekly-trends:
    triggers:
      - schedule:
          cron: "0 0 * * 0" # Every Sunday at midnight
          filters:
            branches:
              only: main
    jobs:
      - trend-analysis:
          context: kubiya-secrets

  # Manual trend analysis
  manual-analysis:
    jobs:
      - trend-analysis:
          context: kubiya-secrets
