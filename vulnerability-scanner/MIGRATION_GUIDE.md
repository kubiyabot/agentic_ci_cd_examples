# ğŸ”„ Migration Guide - Security Updates v2.0.0

This guide helps you migrate your code to work with the updated dependencies after the security vulnerability fixes.

---

## ğŸ“‹ Quick Start

1. **Backup your code** (recommended)
2. **Pull the latest changes**
3. **Install dependencies**: `npm install`
4. **Run tests**: `npm test`
5. **Follow the migration steps below**

---

## ğŸ”§ Step-by-Step Migration

### 1. axios (0.21.1 â†’ 1.7.9)

#### Import Statement (No Changes)
```javascript
const axios = require('axios');
// or
import axios from 'axios';
```

#### Basic Requests (Mostly Compatible)
```javascript
// âœ… These work without changes
await axios.get(url);
await axios.post(url, data);
await axios.put(url, data);
await axios.delete(url);
```

#### Error Handling (UPDATED)
```javascript
// âŒ OLD (0.x)
axios.get(url).catch(error => {
  if (error.response) {
    console.log(error.response.data);
    console.log(error.response.status);
  }
});

// âœ… NEW (1.x) - Same structure, but better typing
axios.get(url).catch(error => {
  if (error.response) {
    console.log(error.response.data);
    console.log(error.response.status);
    console.log(error.response.headers);
  } else if (error.request) {
    console.log(error.request);
  } else {
    console.log('Error', error.message);
  }
});
```

#### Interceptors (Review Required)
```javascript
// âœ… Still works, but review logic
axios.interceptors.request.use(
  config => {
    // Modify request config
    return config;
  },
  error => Promise.reject(error)
);

axios.interceptors.response.use(
  response => response,
  error => Promise.reject(error)
);
```

#### Timeout Behavior (CHANGED)
```javascript
// âš ï¸ Timeout now applies to entire request/response cycle
const instance = axios.create({
  timeout: 5000, // 5 seconds for entire operation
  timeoutErrorMessage: 'Request took too long'
});
```

---

### 2. jsonwebtoken (8.5.1 â†’ 9.0.2)

#### âš ï¸ BREAKING CHANGE: Algorithm Specification Required

#### Token Verification (MUST UPDATE)
```javascript
const jwt = require('jsonwebtoken');

// âŒ OLD (8.x) - INSECURE, auto-detects algorithm
jwt.verify(token, secret);

// âœ… NEW (9.x) - REQUIRED: Specify allowed algorithms
jwt.verify(token, secret, { algorithms: ['HS256'] });

// For RS256 (RSA) tokens
jwt.verify(token, publicKey, { algorithms: ['RS256'] });

// For multiple allowed algorithms
jwt.verify(token, secret, { 
  algorithms: ['HS256', 'HS384', 'HS512'] 
});
```

#### Token Signing (Minor Changes)
```javascript
// âœ… Still works, but be explicit
jwt.sign(payload, secret, { 
  algorithm: 'HS256',  // Explicitly specify
  expiresIn: '1h'
});
```

#### Key Type Validation (New in 9.x)
```javascript
// âœ… Proper key type usage
const privateKey = fs.readFileSync('private.key');
const publicKey = fs.readFileSync('public.key');

// Sign with private key
const token = jwt.sign(payload, privateKey, { algorithm: 'RS256' });

// Verify with public key
jwt.verify(token, publicKey, { algorithms: ['RS256'] });

// âŒ This will now throw an error (mismatched key/algorithm)
// jwt.verify(token, dsaKey, { algorithms: ['RS256'] }); // ERROR!
```

#### Options Changes
```javascript
// âœ… Updated options with better validation
jwt.verify(token, secret, {
  algorithms: ['HS256'],
  audience: 'urn:myapp',
  issuer: 'https://myapp.com',
  clockTolerance: 10, // seconds
  maxAge: '24h'
});
```

---

### 3. moment â†’ dayjs (Complete Replacement)

#### Installation
```javascript
// âŒ Remove moment
npm uninstall moment

// âœ… Already included in package.json
// dayjs is installed automatically
```

#### Basic Usage
```javascript
// âŒ OLD (moment)
const moment = require('moment');
const now = moment();
const formatted = moment().format('YYYY-MM-DD');
const future = moment().add(7, 'days');

// âœ… NEW (dayjs)
const dayjs = require('dayjs');
const now = dayjs();
const formatted = dayjs().format('YYYY-MM-DD');
const future = dayjs().add(7, 'day'); // Note: singular 'day'
```

#### Date Manipulation
```javascript
// âŒ OLD
moment().add(7, 'days');
moment().subtract(1, 'months');
moment().startOf('month');
moment().endOf('day');

// âœ… NEW
dayjs().add(7, 'day');
dayjs().subtract(1, 'month');
dayjs().startOf('month');
dayjs().endOf('day');
```

#### Date Parsing
```javascript
// âŒ OLD
moment('2024-01-15');
moment('2024-01-15', 'YYYY-MM-DD');
moment.unix(1516239022);

// âœ… NEW
dayjs('2024-01-15');
dayjs('2024-01-15', 'YYYY-MM-DD');
dayjs.unix(1516239022);
```

#### Plugins (If needed)
```javascript
// dayjs uses plugins for extended functionality
const dayjs = require('dayjs');
const utc = require('dayjs/plugin/utc');
const timezone = require('dayjs/plugin/timezone');

dayjs.extend(utc);
dayjs.extend(timezone);

// Now you can use UTC and timezone functions
dayjs.utc();
dayjs.tz('2024-01-15', 'America/New_York');
```

---

### 4. serialize-javascript (4.0.0 â†’ 6.0.2)

#### Basic Usage (Mostly Compatible)
```javascript
const serialize = require('serialize-javascript');

// âœ… Still works
const serialized = serialize({ foo: 'bar' });
const obj = eval('(' + serialized + ')');
```

#### Security Improvements (Automatic)
```javascript
// âœ… NEW: Better sanitization of special characters
const data = {
  regex: /test/gi,
  date: new Date(),
  url: new URL('https://example.com'),
  fn: function() { return 'hello'; }
};

// Now properly sanitizes potential XSS vectors
const safe = serialize(data);
```

#### Options (Review if used)
```javascript
// âœ… Check if you're using custom options
serialize(data, {
  space: 2,        // Still works
  isJSON: true,    // Still works
  unsafe: false    // Still works
});
```

---

### 5. express (4.17.1 â†’ 4.21.2)

#### Basic Usage (No Changes)
```javascript
const express = require('express');
const app = express();

// âœ… All existing code should work
app.get('/', (req, res) => {
  res.send('Hello World');
});
```

#### Redirect Handling (Improved Security)
```javascript
// âœ… Redirects now properly validate URLs
app.get('/redirect', (req, res) => {
  const url = req.query.url;
  
  // Better: Validate redirect URLs
  const allowedDomains = ['https://myapp.com', 'https://api.myapp.com'];
  if (allowedDomains.some(domain => url.startsWith(domain))) {
    res.redirect(url);
  } else {
    res.status(400).send('Invalid redirect');
  }
});
```

#### Body Parser (Already Built-in)
```javascript
// âœ… Still works
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
```

---

### 6. Minor Updates (No Code Changes)

#### lodash (4.17.20 â†’ 4.17.21)
```javascript
// âœ… No code changes required
const _ = require('lodash');
// All functions work identically
```

#### minimist (1.2.5 â†’ 1.2.8)
```javascript
// âœ… No code changes required
const argv = require('minimist')(process.argv.slice(2));
```

#### node-fetch (2.6.1 â†’ 2.7.0)
```javascript
// âœ… No code changes required
const fetch = require('node-fetch');
await fetch('https://api.example.com');
```

#### shell-quote (1.7.2 â†’ 1.8.1)
```javascript
// âœ… No code changes required
const { quote, parse } = require('shell-quote');
```

#### underscore (1.12.0 â†’ 1.13.7)
```javascript
// âœ… No code changes required
const _ = require('underscore');
```

---

## ğŸ§ª Testing Your Migration

### 1. Unit Tests
```bash
npm test
```

### 2. Integration Tests
```bash
npm run test:integration
# (if you have integration tests)
```

### 3. Manual Testing
```bash
# Start the application
npm start

# Test critical paths:
# - Authentication (JWT)
# - API calls (axios)
# - Date operations (dayjs)
# - Any custom functionality
```

### 4. Security Audit
```bash
npm audit
# Expected: 0 vulnerabilities
```

---

## ğŸ” Common Issues & Solutions

### Issue: JWT verification fails
**Cause:** Missing `algorithms` parameter  
**Solution:** Add `algorithms: ['HS256']` to all `jwt.verify()` calls

### Issue: Date formatting different
**Cause:** dayjs uses singular forms (e.g., 'day' not 'days')  
**Solution:** Update all `.add()` and `.subtract()` calls to use singular units

### Issue: axios interceptor not working
**Cause:** Interceptor logic may need review  
**Solution:** Check error handling in interceptors, ensure proper return values

### Issue: Tests failing
**Cause:** Dependency behavior changes  
**Solution:** Update test mocks and expectations to match new behavior

---

## ğŸ“ Support

If you encounter issues during migration:

1. **Check the logs**: `npm install --verbose`
2. **Review test failures**: `npm test -- --verbose`
3. **Consult documentation**:
   - [axios changelog](https://github.com/axios/axios/blob/main/CHANGELOG.md)
   - [jsonwebtoken migration](https://github.com/auth0/node-jsonwebtoken#migration-notes)
   - [dayjs docs](https://day.js.org/docs/en/installation/installation)
4. **Contact**: security@kubiya.ai

---

## âœ… Migration Checklist

- [ ] Backup code and database
- [ ] Update `package.json` dependencies
- [ ] Run `npm install`
- [ ] Update JWT verification calls (add `algorithms`)
- [ ] Replace `moment` with `dayjs`
- [ ] Review axios error handling
- [ ] Test all critical paths
- [ ] Run `npm audit` (should show 0 vulnerabilities)
- [ ] Update CI/CD pipelines if needed
- [ ] Deploy to staging environment
- [ ] Monitor for errors
- [ ] Deploy to production

---

**Estimated Migration Time:** 2-4 hours  
**Difficulty:** ğŸŸ¡ Medium  
**Risk Level:** ğŸŸ¢ Low (with proper testing)

---

**Last Updated:** February 1, 2026  
**Document Version:** 1.0.0
