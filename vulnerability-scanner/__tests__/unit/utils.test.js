const {
  formatVulnerability,
  groupBySeverity,
  filterVulnerabilities,
  generateMarkdownReport,
  calculateRiskDelta,
} = require('../../src/utils');

describe('formatVulnerability', () => {
  it('should format vulnerability with fix available', () => {
    const vuln = {
      id: 'CVE-2021-23337',
      package: 'lodash',
      installedVersion: '4.17.20',
      fixedVersion: '4.17.21',
      severity: 'HIGH',
      hasFixAvailable: true,
    };

    const result = formatVulnerability(vuln);

    expect(result.display).toContain('[HIGH]');
    expect(result.display).toContain('CVE-2021-23337');
    expect(result.display).toContain('lodash@4.17.20');
    expect(result.display).toContain('Fix: 4.17.21');
    expect(result.shortDisplay).toBe('CVE-2021-23337: lodash (HIGH)');
  });

  it('should format vulnerability without fix', () => {
    const vuln = {
      id: 'CVE-2021-99999',
      package: 'some-pkg',
      installedVersion: '1.0.0',
      severity: 'MEDIUM',
      hasFixAvailable: false,
    };

    const result = formatVulnerability(vuln);

    expect(result.display).toContain('No fix available');
  });
});

describe('groupBySeverity', () => {
  it('should group vulnerabilities by severity', () => {
    const vulnerabilities = [
      { id: '1', severity: 'CRITICAL' },
      { id: '2', severity: 'HIGH' },
      { id: '3', severity: 'HIGH' },
      { id: '4', severity: 'MEDIUM' },
      { id: '5', severity: 'LOW' },
    ];

    const grouped = groupBySeverity(vulnerabilities);

    expect(grouped.CRITICAL).toHaveLength(1);
    expect(grouped.HIGH).toHaveLength(2);
    expect(grouped.MEDIUM).toHaveLength(1);
    expect(grouped.LOW).toHaveLength(1);
    expect(grouped.UNKNOWN).toHaveLength(0);
  });

  it('should handle unknown severity', () => {
    const vulnerabilities = [{ id: '1', severity: 'UNKNOWN' }, { id: '2' }];

    const grouped = groupBySeverity(vulnerabilities);

    expect(grouped.UNKNOWN).toHaveLength(2);
  });
});

describe('filterVulnerabilities', () => {
  const vulnerabilities = [
    { id: '1', severity: 'CRITICAL', hasFixAvailable: true, package: 'pkg1' },
    { id: '2', severity: 'HIGH', hasFixAvailable: false, package: 'pkg2' },
    { id: '3', severity: 'MEDIUM', hasFixAvailable: true, package: 'pkg1' },
    { id: '4', severity: 'LOW', hasFixAvailable: true, package: 'pkg3' },
  ];

  it('should filter by minimum severity', () => {
    const filtered = filterVulnerabilities(vulnerabilities, {
      minSeverity: 'HIGH',
    });

    expect(filtered).toHaveLength(2);
    expect(filtered.map((v) => v.id)).toEqual(['1', '2']);
  });

  it('should filter fixable only', () => {
    const filtered = filterVulnerabilities(vulnerabilities, {
      fixableOnly: true,
    });

    expect(filtered).toHaveLength(3);
    expect(filtered.find((v) => v.id === '2')).toBeUndefined();
  });

  it('should filter by packages', () => {
    const filtered = filterVulnerabilities(vulnerabilities, {
      packages: ['pkg1'],
    });

    expect(filtered).toHaveLength(2);
    expect(filtered.every((v) => v.package === 'pkg1')).toBe(true);
  });

  it('should combine multiple filters', () => {
    const filtered = filterVulnerabilities(vulnerabilities, {
      minSeverity: 'MEDIUM',
      fixableOnly: true,
    });

    expect(filtered).toHaveLength(2);
    expect(filtered.map((v) => v.id)).toEqual(['1', '3']);
  });
});

describe('generateMarkdownReport', () => {
  it('should generate markdown report', () => {
    const analysis = {
      vulnerabilities: [
        {
          id: 'CVE-2021-23337',
          package: 'lodash',
          installedVersion: '4.17.20',
          fixedVersion: '4.17.21',
          severity: 'CRITICAL',
          title: 'Command Injection',
          hasFixAvailable: true,
        },
      ],
      summary: {
        total: 1,
        bySeverity: { CRITICAL: 1, HIGH: 0, MEDIUM: 0, LOW: 0 },
        fixable: 1,
        riskScore: 10,
      },
    };

    const md = generateMarkdownReport(analysis);

    expect(md).toContain('# Vulnerability Scan Report');
    expect(md).toContain('| Total Vulnerabilities | 1 |');
    expect(md).toContain('| Critical | 1 |');
    expect(md).toContain('CVE-2021-23337');
    expect(md).toContain('lodash@4.17.20');
  });

  it('should handle report with no critical issues', () => {
    const analysis = {
      vulnerabilities: [{ id: 'CVE-1', severity: 'LOW' }],
      summary: {
        total: 1,
        bySeverity: { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 1 },
        fixable: 0,
        riskScore: 1,
      },
    };

    const md = generateMarkdownReport(analysis);

    expect(md).toContain('# Vulnerability Scan Report');
    expect(md).not.toContain('Critical & High Severity Issues');
  });
});

describe('calculateRiskDelta', () => {
  it('should calculate delta between scans', () => {
    const current = {
      total: 10,
      riskScore: 50,
      bySeverity: { CRITICAL: 1, HIGH: 3, MEDIUM: 4, LOW: 2 },
    };

    const previous = {
      total: 8,
      riskScore: 40,
      bySeverity: { CRITICAL: 0, HIGH: 2, MEDIUM: 4, LOW: 2 },
    };

    const delta = calculateRiskDelta(current, previous);

    expect(delta.totalDelta).toBe(2);
    expect(delta.riskDelta).toBe(10);
    expect(delta.severityChanges.CRITICAL).toBe(1);
    expect(delta.severityChanges.HIGH).toBe(1);
  });

  it('should detect degraded trend', () => {
    const current = { total: 20, riskScore: 100, bySeverity: {} };
    const previous = { total: 5, riskScore: 20, bySeverity: {} };

    const delta = calculateRiskDelta(current, previous);

    expect(delta.trend).toBe('DEGRADED');
  });

  it('should detect improved trend', () => {
    const current = { total: 5, riskScore: 10, bySeverity: {} };
    const previous = { total: 15, riskScore: 50, bySeverity: {} };

    const delta = calculateRiskDelta(current, previous);

    expect(delta.trend).toBe('IMPROVED');
  });

  it('should handle baseline (no previous)', () => {
    const current = { total: 5, riskScore: 25, bySeverity: {} };

    const delta = calculateRiskDelta(current, null);

    expect(delta.trend).toBe('BASELINE');
    expect(delta.newVulnerabilities).toBe(5);
  });
});
