const {
  VulnerabilityAnalyzer,
  generatePackageJsonPatch,
} = require('../../src/report-analyzer');

describe('VulnerabilityAnalyzer', () => {
  let analyzer;

  beforeEach(() => {
    analyzer = new VulnerabilityAnalyzer();
  });

  describe('parseReport', () => {
    it('should parse empty report', () => {
      const result = analyzer.parseReport(null);
      expect(result.vulnerabilities).toEqual([]);
      expect(result.summary.total).toBe(0);
    });

    it('should parse Trivy JSON output', () => {
      const trivyOutput = {
        Results: [
          {
            Target: 'package.json',
            Vulnerabilities: [
              {
                VulnerabilityID: 'CVE-2021-23337',
                PkgName: 'lodash',
                InstalledVersion: '4.17.20',
                FixedVersion: '4.17.21',
                Severity: 'HIGH',
                Title: 'Command Injection',
                Description: 'Lodash vulnerability description',
              },
              {
                VulnerabilityID: 'CVE-2021-3749',
                PkgName: 'axios',
                InstalledVersion: '0.21.1',
                FixedVersion: '0.21.2',
                Severity: 'CRITICAL',
                Title: 'ReDoS vulnerability',
              },
            ],
          },
        ],
      };

      const result = analyzer.parseReport(trivyOutput);

      expect(result.vulnerabilities).toHaveLength(2);
      expect(result.summary.total).toBe(2);
      expect(result.summary.bySeverity.HIGH).toBe(1);
      expect(result.summary.bySeverity.CRITICAL).toBe(1);
      expect(result.summary.fixable).toBe(2);
    });

    it('should handle vulnerabilities without fix', () => {
      const trivyOutput = {
        Results: [
          {
            Target: 'package.json',
            Vulnerabilities: [
              {
                VulnerabilityID: 'CVE-2021-99999',
                PkgName: 'some-package',
                InstalledVersion: '1.0.0',
                Severity: 'MEDIUM',
                Title: 'Some vulnerability',
              },
            ],
          },
        ],
      };

      const result = analyzer.parseReport(trivyOutput);

      expect(result.vulnerabilities[0].hasFixAvailable).toBe(false);
      expect(result.summary.unfixable).toBe(1);
    });
  });

  describe('calculateSummary', () => {
    it('should calculate risk score correctly', () => {
      const vulnerabilities = [
        { severity: 'CRITICAL', hasFixAvailable: true, package: 'pkg1' },
        { severity: 'HIGH', hasFixAvailable: true, package: 'pkg2' },
        { severity: 'MEDIUM', hasFixAvailable: false, package: 'pkg3' },
        { severity: 'LOW', hasFixAvailable: true, package: 'pkg1' },
      ];

      const summary = analyzer.calculateSummary(vulnerabilities);

      // CRITICAL(10) + HIGH(7) + MEDIUM(4) + LOW(1) = 22
      expect(summary.riskScore).toBe(22);
      expect(summary.fixable).toBe(3);
      expect(summary.unfixable).toBe(1);
      expect(summary.uniquePackages).toBe(3);
    });
  });

  describe('generateRecommendations', () => {
    it('should generate update recommendations', () => {
      const vulnerabilities = [
        {
          id: 'CVE-1',
          package: 'lodash',
          installedVersion: '4.17.20',
          fixedVersion: '4.17.21',
          severity: 'HIGH',
          hasFixAvailable: true,
        },
        {
          id: 'CVE-2',
          package: 'lodash',
          installedVersion: '4.17.20',
          fixedVersion: '4.17.21',
          severity: 'MEDIUM',
          hasFixAvailable: true,
        },
      ];

      const recommendations = analyzer.generateRecommendations(vulnerabilities);

      expect(recommendations).toHaveLength(1);
      expect(recommendations[0].package).toBe('lodash');
      expect(recommendations[0].action).toBe('npm install lodash@4.17.21');
      expect(recommendations[0].fixes).toContain('CVE-1');
      expect(recommendations[0].fixes).toContain('CVE-2');
    });

    it('should sort recommendations by priority', () => {
      const vulnerabilities = [
        {
          id: 'CVE-1',
          package: 'pkg-low',
          fixedVersion: '2.0.0',
          severity: 'LOW',
          hasFixAvailable: true,
        },
        {
          id: 'CVE-2',
          package: 'pkg-critical',
          fixedVersion: '2.0.0',
          severity: 'CRITICAL',
          hasFixAvailable: true,
        },
      ];

      const recommendations = analyzer.generateRecommendations(vulnerabilities);

      expect(recommendations[0].package).toBe('pkg-critical');
      expect(recommendations[1].package).toBe('pkg-low');
    });
  });

  describe('shouldFailBuild', () => {
    it('should fail on critical vulnerabilities', () => {
      const summary = {
        bySeverity: { CRITICAL: 1, HIGH: 0 },
        riskScore: 10,
      };

      const result = analyzer.shouldFailBuild(summary);

      expect(result.fail).toBe(true);
      expect(result.reason).toContain('CRITICAL');
    });

    it('should pass when under thresholds', () => {
      const summary = {
        bySeverity: { CRITICAL: 0, HIGH: 2 },
        riskScore: 20,
      };

      const result = analyzer.shouldFailBuild(summary);

      expect(result.fail).toBe(false);
    });

    it('should respect custom thresholds', () => {
      const summary = {
        bySeverity: { CRITICAL: 0, HIGH: 10 },
        riskScore: 70,
      };

      const result = analyzer.shouldFailBuild(summary, {
        maxHigh: 15,
        maxRiskScore: 100,
      });

      expect(result.fail).toBe(false);
    });
  });

  describe('compareVersions', () => {
    it('should compare versions correctly', () => {
      expect(analyzer.compareVersions('1.0.0', '2.0.0')).toBeLessThan(0);
      expect(analyzer.compareVersions('2.0.0', '1.0.0')).toBeGreaterThan(0);
      expect(analyzer.compareVersions('1.0.0', '1.0.0')).toBe(0);
      expect(analyzer.compareVersions('1.0.1', '1.0.0')).toBeGreaterThan(0);
      expect(analyzer.compareVersions('1.1.0', '1.0.9')).toBeGreaterThan(0);
    });
  });
});

describe('generatePackageJsonPatch', () => {
  it('should generate patched package.json', () => {
    const currentPackageJson = {
      name: 'test',
      dependencies: {
        lodash: '4.17.20',
        axios: '0.21.1',
      },
    };

    const recommendations = [
      { type: 'UPDATE', package: 'lodash', fixedVersion: '4.17.21' },
      { type: 'UPDATE', package: 'axios', fixedVersion: '0.21.4' },
    ];

    const patched = generatePackageJsonPatch(
      currentPackageJson,
      recommendations
    );

    expect(patched.dependencies.lodash).toBe('4.17.21');
    expect(patched.dependencies.axios).toBe('0.21.4');
  });

  it('should handle devDependencies', () => {
    const currentPackageJson = {
      devDependencies: {
        jest: '26.0.0',
      },
    };

    const recommendations = [
      { type: 'UPDATE', package: 'jest', fixedVersion: '29.0.0' },
    ];

    const patched = generatePackageJsonPatch(
      currentPackageJson,
      recommendations
    );

    expect(patched.devDependencies.jest).toBe('29.0.0');
  });
});
