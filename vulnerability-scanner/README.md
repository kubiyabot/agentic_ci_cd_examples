# Vulnerability Scanner - Agentic Security Scanning

> ## âš ï¸ **SECURITY WARNING: INTENTIONALLY VULNERABLE CODE** âš ï¸
> 
> **This directory contains deliberately outdated dependencies with known CVEs for demonstration and testing purposes.**
>
> ğŸ”´ **DO NOT DEPLOY TO PRODUCTION**  
> ğŸ”´ **DO NOT USE IN ANY REAL APPLICATION**  
> ğŸ”´ **DO NOT COPY DEPENDENCIES FROM THIS PROJECT**
>
> **Purpose**: Security scanning demonstration and vulnerability detection training  
> **Status**: Contains 17+ known CVEs including CRITICAL severity issues  
> **Last Security Audit**: January 26, 2026
>
> For detailed vulnerability information, see [SECURITY_REPORT.md](../SECURITY_REPORT.md)

---

This use case demonstrates **intelligent vulnerability scanning** using Kubiya's agentic CI/CD capabilities. Unlike traditional scanners that simply output findings, this approach leverages an AI agent that:

- **Recalls** past vulnerability history and remediation patterns from organizational memory
- **Analyzes** scan results with context and historical awareness
- **Prioritizes** fixes based on severity, exploitability, and organizational patterns
- **Creates PRs** with automated dependency patches
- **Stores** learnings for continuous improvement across the organization

## How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GitHub Actions Workflow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Install Security Tools (Trivy, npm audit, etc.)                        â”‚
â”‚                           â†“                                                  â”‚
â”‚  2. Kubiya Agent Executes with Full Pipeline Access                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  PHASE 1: Recall organizational memory                          â”‚    â”‚
â”‚     â”‚    - Previous scan history for this repo                        â”‚    â”‚
â”‚     â”‚    - Known false positives                                       â”‚    â”‚
â”‚     â”‚    - Successful remediation patterns                            â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 2: Execute comprehensive scans                           â”‚    â”‚
â”‚     â”‚    - trivy fs . --format json                                   â”‚    â”‚
â”‚     â”‚    - npm audit --json                                           â”‚    â”‚
â”‚     â”‚    - Secrets pattern detection                                  â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 3: Analyze with historical context                       â”‚    â”‚
â”‚     â”‚    - Categorize by severity                                      â”‚    â”‚
â”‚     â”‚    - Identify NEW vs RECURRING issues                           â”‚    â”‚
â”‚     â”‚    - Calculate risk scores                                       â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 4: Generate remediation plan                             â”‚    â”‚
â”‚     â”‚    - Prioritized fix commands                                    â”‚    â”‚
â”‚     â”‚    - Code change suggestions                                     â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 5: Create fix PR (if critical issues)                    â”‚    â”‚
â”‚     â”‚    - Update package.json with fixed versions                    â”‚    â”‚
â”‚     â”‚    - Commit, push, and create PR via gh CLI                     â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 6: Store learnings to memory                             â”‚    â”‚
â”‚     â”‚    - Scan results for trend analysis                            â”‚    â”‚
â”‚     â”‚    - New remediation patterns discovered                        â”‚    â”‚
â”‚     â”‚                                                                  â”‚    â”‚
â”‚     â”‚  PHASE 7: Report summary with CI decision                       â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                                  â”‚
â”‚  3. Run Tests & Upload Artifacts                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Features

### 1. Organizational Memory Integration

The agent leverages Kubiya's memory system to:

```javascript
// Recall past vulnerabilities
recall_memory('vulnerability scan history for this repository')
recall_memory('security remediation patterns')

// Store new findings
store_memory({
  dataset: 'vulnerability-scan-history',
  content: 'Scan results summary',
  metadata: {
    repository: 'org/repo',
    risk_score: 45,
    critical_count: 0,
    high_count: 3
  }
})
```

### 2. Automated PR Creation

When critical vulnerabilities with available fixes are detected, the agent:

1. Creates a new branch
2. Updates `package.json` with fixed versions
3. Commits changes with detailed CVE information
4. Creates a PR via GitHub CLI

### 3. Contextual Analysis

Unlike basic scanners, the agent:

- Identifies **NEW** vulnerabilities vs **RECURRING** issues
- Detects **REGRESSIONS** (previously fixed, now reintroduced)
- Applies organizational patterns to reduce false positives
- Provides trend analysis (improving/degrading/stable)

### 4. Risk-Based CI Decisions

```
PASS: No CRITICAL, â‰¤5 HIGH, risk score < 50
WARN: Some HIGH vulnerabilities but manageable
FAIL: CRITICAL vulnerabilities or risk score > 100
```

## Project Structure

```
vulnerability-scanner/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ vulnerability-scan.yml   # GitHub Actions workflow
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                     # Example app with vulnerabilities
â”‚   â”œâ”€â”€ report-analyzer.js           # Trivy output parser
â”‚   â””â”€â”€ utils.js                     # Helper utilities
â”œâ”€â”€ __tests__/
â”‚   â””â”€â”€ unit/
â”‚       â”œâ”€â”€ report-analyzer.test.js
â”‚       â””â”€â”€ utils.test.js
â”œâ”€â”€ package.json                     # Intentionally vulnerable deps
â”œâ”€â”€ jest.config.js
â””â”€â”€ README.md
```

## Known Vulnerable Dependencies (Intentional)

> âš ï¸ **These are INTENTIONALLY OUTDATED for demonstration purposes**

The `package.json` includes intentionally vulnerable packages:

| Package | Version | CVE | Severity | Description |
|---------|---------|-----|----------|-------------|
| **minimist** | 1.2.5 | CVE-2021-44906 | ğŸ”´ CRITICAL (9.8) | Prototype Pollution |
| **jsonwebtoken** | 8.5.1 | CVE-2022-23529 | ğŸŸ  HIGH (7.6) | Remote Code Execution |
| **lodash** | 4.17.20 | CVE-2021-23337 | ğŸŸ  HIGH (7.4) | Command Injection |
| **axios** | 0.21.1 | CVE-2021-3749 | ğŸŸ  HIGH (7.8) | Regular Expression DoS |
| **express** | 4.17.1 | Multiple CVEs | ğŸŸ  HIGH (7.5) | DoS, Open Redirect, Code Exec |
| **node-fetch** | 2.6.1 | CVE-2022-0235 | ğŸŸ¡ MEDIUM (6.5) | Information Exposure |
| **serialize-javascript** | 4.0.0 | Multiple XSS | ğŸŸ  HIGH | Cross-Site Scripting |
| **shell-quote** | 1.7.2 | Command Injection | ğŸŸ  HIGH | Command Injection |
| **moment** | 2.29.1 | ReDoS | ğŸŸ¡ MEDIUM | Regular Expression DoS |
| **underscore** | 1.12.0 | Code Execution | ğŸŸ¡ MEDIUM | Arbitrary Code Execution |

**Total: 17+ Known CVEs** | See [SECURITY_REPORT.md](../SECURITY_REPORT.md) for details

## Running Locally

### Run Tests
```bash
cd vulnerability-scanner
npm install  # âš ï¸ Installs vulnerable packages
npm test
```

### Manual Trivy Scan
```bash
# Install Trivy (macOS)
brew install trivy

# Run scan
trivy fs . --severity HIGH,CRITICAL
```

### With Kubiya CLI
```bash
# Install Kubiya CLI
curl -fsSL https://cli.kubiya.ai/install.sh | bash

# Run intelligent scan
kubiya exec "Scan this directory for vulnerabilities using trivy, analyze the results, and suggest fixes" --local --cwd .
```

## Memory Datasets

The agent uses these memory datasets:

| Dataset | Purpose |
|---------|---------|
| `vulnerability-scan-history` | Track scan results over time |
| `security-remediation-patterns` | Successful fix patterns |
| `security-false-positives` | Known false positives to ignore |
| `security-policies` | Organizational security thresholds |

## Workflow Configuration

### Required Secrets

- `KUBIYA_API_KEY`: Your Kubiya API key
- `GITHUB_TOKEN`: Automatically provided (for PR creation)

### Triggers

The workflow runs on:
- Push to `vulnerability-scanner/**`
- Pull requests affecting `vulnerability-scanner/**`
- Manual dispatch

## Comparison: Baseline vs Intelligent

| Aspect | Baseline Scan | Intelligent Scan |
|--------|--------------|------------------|
| Tool Execution | Static commands | Dynamic, context-aware |
| Analysis | Raw output | Categorized with history |
| Remediation | Manual | Automated PR creation |
| Learning | None | Stores patterns to memory |
| False Positives | All reported | Filtered by org knowledge |
| Trend Detection | None | Compares with history |

## Best Practices

1. **Memory Hygiene**: Periodically review stored patterns
2. **Threshold Tuning**: Adjust risk thresholds per repository
3. **PR Review**: Always review auto-generated fix PRs
4. **Incremental Fixes**: Don't fix everything at once - prioritize
5. **ğŸ”´ NEVER use these vulnerable dependencies in production**

## Security Notice

This directory is designed for:
- âœ… Security scanning demonstrations
- âœ… Vulnerability detection training
- âœ… Testing security tools
- âœ… CI/CD pipeline examples

This directory is NOT for:
- âŒ Production deployments
- âŒ Real applications
- âŒ Copying dependency versions
- âŒ Any environment with real data

## Related Use Cases

- [Incident Learning Pipeline](../incident-learning-pipeline/) - Learn from CI failures
- [Build Artifact Analyzer](../build-artifact-analyzer/) - Analyze build outputs
- [Cross-Repo Knowledge Share](../cross-repo-knowledge-share/) - Org-wide patterns
