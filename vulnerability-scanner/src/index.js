/**
 * Example application with intentional security vulnerabilities
 * Used for demonstrating agentic vulnerability scanning
 *
 * DO NOT USE IN PRODUCTION - This code contains intentional vulnerabilities
 */

const express = require('express');
const _ = require('lodash');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const { exec } = require('child_process');

const app = express();
app.use(express.json());

// VULNERABILITY: Prototype Pollution via lodash merge (CVE-2020-8203)
app.post('/api/config', (req, res) => {
  const defaultConfig = { theme: 'light', language: 'en' };
  // Vulnerable: Using merge with user input can lead to prototype pollution
  const config = _.merge({}, defaultConfig, req.body);
  res.json(config);
});

// VULNERABILITY: SQL Injection pattern (simulated)
app.get('/api/users', (req, res) => {
  const userId = req.query.id;
  // Vulnerable: Direct string concatenation with user input
  const query = `SELECT * FROM users WHERE id = '${userId}'`;
  console.log('Executing query:', query);
  res.json({ query, message: 'Query would execute (simulated)' });
});

// VULNERABILITY: Command Injection
app.post('/api/process', (req, res) => {
  const filename = req.body.filename;
  // Vulnerable: User input passed directly to shell command
  exec(`cat /tmp/${filename}`, (error, stdout, stderr) => {
    if (error) {
      return res.status(500).json({ error: error.message });
    }
    res.json({ content: stdout });
  });
});

// VULNERABILITY: Weak JWT secret
const JWT_SECRET = 'secret123'; // Hardcoded weak secret

app.post('/api/login', (req, res) => {
  const { username, password } = req.body;
  // Simulated authentication
  if (username && password) {
    const token = jwt.sign({ username }, JWT_SECRET, { expiresIn: '1h' });
    res.json({ token });
  } else {
    res.status(401).json({ error: 'Invalid credentials' });
  }
});

// VULNERABILITY: Path Traversal
app.get('/api/files', (req, res) => {
  const filename = req.query.file;
  // Vulnerable: No path validation allows directory traversal
  const filepath = `./uploads/${filename}`;
  res.json({ filepath, message: 'Would read file (simulated)' });
});

// VULNERABILITY: Insecure Deserialization pattern
app.post('/api/data', (req, res) => {
  const serialized = req.body.data;
  // Vulnerable: Using eval for deserialization
  try {
    const data = eval('(' + serialized + ')');
    res.json({ data });
  } catch (e) {
    res.status(400).json({ error: 'Invalid data format' });
  }
});

// VULNERABILITY: Missing rate limiting, CORS misconfiguration
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*'); // Too permissive
  next();
});

const PORT = process.env.PORT || 3000;

// Only start server if not in test mode
if (process.env.NODE_ENV !== 'test') {
  app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
  });
}

module.exports = { app, JWT_SECRET };
