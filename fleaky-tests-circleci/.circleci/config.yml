version: 2.1

# =============================================================================
# Kubiya Intelligent CI/CD Pipeline - Flaky Test Detection
# =============================================================================
#
# This pipeline demonstrates intelligent test execution:
# 1. Clone from public repo: https://github.com/kubiyabot/agentic_ci_cd_examples
# 2. Analyze tests for flaky patterns (Math.random, timing, async issues)
# 3. Skip known flaky tests automatically
# 4. Run only stable tests
# 5. Report findings with reasoning
#
# Required Environment Variables (set in CircleCI context 'kubiya-secrets'):
#   - KUBIYA_API_KEY: Your Kubiya API key
#
# Local testing:
#   make test-flaky-kubiya
# =============================================================================

jobs:
  # Baseline approach: Run all tests without Kubiya (for comparison)
  test-without-kubiya:
    docker:
      - image: cimg/node:20.11
    steps:
      - run:
          name: Clone Repository
          command: |
            git clone https://github.com/kubiyabot/agentic_ci_cd_examples.git repo
            cd repo && git log -1 --oneline

      - run:
          name: Navigate to Flaky Tests Example
          command: cd repo/fleaky-tests-circleci && ls -la

      - restore_cache:
          keys:
            - v1-flaky-deps-{{ checksum "repo/fleaky-tests-circleci/package.json" }}
            - v1-flaky-deps-

      - run:
          name: Install Dependencies
          command: cd repo/fleaky-tests-circleci && npm ci

      - save_cache:
          paths:
            - repo/fleaky-tests-circleci/node_modules
          key: v1-flaky-deps-{{ checksum "repo/fleaky-tests-circleci/package.json" }}

      - run:
          name: Run All Tests (Including Flaky Ones)
          command: |
            cd repo/fleaky-tests-circleci
            echo "=== BASELINE: Running ALL tests ==="
            echo "This includes flaky tests that may fail randomly"
            echo ""
            npm run test:all || true
            echo ""
            echo "Note: Some tests likely failed due to flakiness"

      - store_test_results:
          path: repo/fleaky-tests-circleci/coverage

  # ==========================================================================
  # INTELLIGENT APPROACH: Kubiya analyzes and skips flaky tests
  # Uses direct agent execution (no planning phase) for faster CI/CD
  # ==========================================================================
  test-with-kubiya:
    docker:
      - image: cimg/node:20.11
    environment:
      # Note: In real CircleCI, use contexts for secrets
      # For local execute, pass via: -e KB_KEY="..." -e KB_AGENT="..."
      KUBIYA_NON_INTERACTIVE: "true"
    steps:
      - run:
          name: Clone Repository
          command: |
            git clone https://github.com/kubiyabot/agentic_ci_cd_examples.git repo
            cd repo && git log -1 --oneline

      - run:
          name: Navigate to Flaky Tests Example
          command: cd repo/fleaky-tests-circleci && ls -la

      - restore_cache:
          keys:
            - v1-flaky-deps-{{ checksum "repo/fleaky-tests-circleci/package.json" }}
            - v1-flaky-deps-

      - run:
          name: Install Dependencies
          command: cd repo/fleaky-tests-circleci && npm ci

      - save_cache:
          paths:
            - repo/fleaky-tests-circleci/node_modules
          key: v1-flaky-deps-{{ checksum "repo/fleaky-tests-circleci/package.json" }}

      - run:
          name: Install Kubiya CLI
          command: |
            curl -fsSL https://raw.githubusercontent.com/kubiyabot/cli/main/install.sh | bash
            echo 'export PATH="$HOME/.kubiya/bin:$PATH"' >> $BASH_ENV

      - run:
          name: Intelligent Test Execution
          command: |
            cd repo/fleaky-tests-circleci

            echo "=== KUBIYA INTELLIGENT TEST EXECUTION ==="
            echo ""

            kubiya exec "
            You are an intelligent CI/CD agent analyzing tests for flaky patterns.

            TASK: Analyze and run tests intelligently

            STEP 1 - Analyze flaky test directory:
            List files in __tests__/flaky/ and analyze each for flaky patterns:
            - Math.random() usage (causes random failures)
            - new Date() or time-based logic (timing dependent)
            - setTimeout with variable delays (async race conditions)

            STEP 2 - Report findings:
            For each flaky test found, explain:
            - File path
            - Type of flakiness (RANDOM, TIMING, ASYNC)
            - Why it would fail intermittently

            STEP 3 - Run stable tests only:
            Execute: npm run test:unit
            This runs only the stable unit tests, skipping flaky ones.

            STEP 4 - Summary:
            Report how many tests were run vs skipped and overall results.
            " --local --cwd . --yes

            echo ""
            echo "=== Kubiya execution complete ==="

      - store_test_results:
          path: repo/fleaky-tests-circleci/coverage

# =============================================================================
# Workflow Definitions
# =============================================================================
workflows:
  version: 2

  # Run without Kubiya (baseline for comparison)
  baseline-testing:
    jobs:
      - test-without-kubiya:
          filters:
            branches:
              only:
                - baseline

  # Run with Kubiya (default, recommended)
  intelligent-testing:
    jobs:
      - test-with-kubiya:
          context:
            - kubiya-secrets
          filters:
            branches:
              ignore:
                - baseline

  # Run both for comparison (manual trigger)
  compare-approaches:
    jobs:
      - test-without-kubiya:
          name: "Baseline: All Tests"
      - test-with-kubiya:
          name: "Kubiya: Intelligent"
          context:
            - kubiya-secrets
