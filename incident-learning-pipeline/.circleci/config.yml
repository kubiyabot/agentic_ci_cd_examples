version: 2.1

orbs:
  node: circleci/node@5.1.0

# ============================================================
# INCIDENT LEARNING PIPELINE
# Demonstrates Kubiya Cognitive Memory for failure learning
# ============================================================

# Environment variables for memory datasets (set in CircleCI context or project settings)
# KUBIYA_DATASET_FAILURES - Dataset for failure learnings (default: "default")
# KUBIYA_DATASET_BUILD_HISTORY - Dataset for build history (default: "default")
# KUBIYA_DATASET_TEST_PATTERNS - Dataset for test patterns (default: "default")

executors:
  node-executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project
    environment:
      KUBIYA_DATASET_FAILURES: ${KUBIYA_DATASET_FAILURES:-default}
      KUBIYA_DATASET_BUILD_HISTORY: ${KUBIYA_DATASET_BUILD_HISTORY:-default}
      KUBIYA_DATASET_TEST_PATTERNS: ${KUBIYA_DATASET_TEST_PATTERNS:-default}

commands:
  install-kubiya-cli:
    description: Install Kubiya CLI
    steps:
      - run:
          name: Install Kubiya CLI
          command: |
            curl -fsSL https://raw.githubusercontent.com/kubiyabot/cli/main/install.sh | bash
            echo 'export PATH="$HOME/.kubiya/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

  recall-failure-context:
    description: Recall previous failure learnings from memory
    steps:
      - run:
          name: Recall Previous Failure Learnings
          command: |
            echo "=== Recalling Failure Learnings from Organizational Memory ==="

            # Recall known failures for this repository
            FAILURE_CONTEXT=$(kubiya memory recall "failures in ${CIRCLE_PROJECT_REPONAME}" \
              --top-k 10 --output json 2>/dev/null || echo "{}")

            # Recall known workarounds
            WORKAROUND_CONTEXT=$(kubiya memory recall "workarounds for integration test failures" \
              --top-k 5 --output json 2>/dev/null || echo "{}")

            # Save to environment for next steps
            echo "export FAILURE_CONTEXT='$FAILURE_CONTEXT'" >> $BASH_ENV
            echo "export WORKAROUND_CONTEXT='$WORKAROUND_CONTEXT'" >> $BASH_ENV

            echo "Recalled failure context and workarounds from memory"

  store-failure-learning:
    description: Analyze and store failure learnings
    parameters:
      test_type:
        type: string
        default: "unit"
    steps:
      - run:
          name: Analyze and Store Failure Learning
          when: on_fail
          command: |
            echo "=== Analyzing Failure and Storing to Memory ==="

            kubiya exec "
              You are a CI failure analyst. A << parameters.test_type >> test failure just occurred in ${CIRCLE_PROJECT_REPONAME} (build #${CIRCLE_BUILD_NUM}, branch: ${CIRCLE_BRANCH}).

              TASK:
              1. Read the test output and identify which tests failed and why
              2. Categorize the failure (INFRASTRUCTURE, TIMEOUT, FLAKY, CODE, or CONFIGURATION)
              3. Analyze the root cause
              4. Store your analysis to memory for future runs
              5. Suggest an immediate workaround and a permanent fix

              Be specific and actionable in your analysis.
            " --local --cwd . --yes

jobs:
  # ============================================================
  # BASELINE: Standard test run without intelligence
  # ============================================================
  test-baseline:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run All Tests (Baseline)
          command: npm test
      - store_test_results:
          path: coverage

  # ============================================================
  # INTELLIGENT: Test run with memory-driven learning
  # ============================================================
  test-with-learning:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - install-kubiya-cli

      # Phase 1: Recall previous learnings
      - recall-failure-context

      # Phase 2: Pre-execution intelligence
      - run:
          name: Apply Learned Workarounds
          command: |
            echo "=== Applying Organizational Learnings ==="

            kubiya exec "
              PREVIOUS FAILURE LEARNINGS:
              $FAILURE_CONTEXT

              KNOWN WORKAROUNDS:
              $WORKAROUND_CONTEXT

              TASK: Prepare for test execution in ${CIRCLE_PROJECT_REPONAME}

              1. Analyze the recalled learnings
              2. Identify if any known issues apply to this run
              3. If there are applicable workarounds, apply them (adjust timeouts, skip flaky tests, etc.)
              4. Report what adjustments were made

              DO NOT actually run tests - just prepare the environment.
            " --local --cwd . --yes

      # Phase 3: Run unit tests
      - run:
          name: Run Unit Tests
          command: npm run test:unit -- --json --outputFile=unit-results.json
      - store-failure-learning:
          test_type: "unit"

      # Phase 4: Run integration tests
      - run:
          name: Run Integration Tests
          command: npm run test:integration -- --json --outputFile=integration-results.json
      - store-failure-learning:
          test_type: "integration"

      # Phase 5: Success learning
      - run:
          name: Store Success Insights
          when: on_success
          command: |
            kubiya exec "
              The test run succeeded for ${CIRCLE_PROJECT_REPONAME} (build #${CIRCLE_BUILD_NUM}, branch: ${CIRCLE_BRANCH}).

              TASK:
              1. If previous runs had failures that are now passing, document what fixed the issue
              2. Store a success record to memory for trend tracking
            " --local --cwd . --yes

      - store_test_results:
          path: coverage
      - store_artifacts:
          path: unit-results.json
      - store_artifacts:
          path: integration-results.json

  # ============================================================
  # FULL LEARNING LOOP: Autonomous agent with memory
  # ============================================================
  autonomous-learning-pipeline:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - install-kubiya-cli

      - run:
          name: Execute Autonomous Learning Pipeline
          command: |
            kubiya exec "
              You are an intelligent CI agent with organizational memory for ${CIRCLE_PROJECT_REPONAME}.

              TASK: Execute tests with learning

              1. RECALL: Check organizational memory for previous test failures, infrastructure issues, and successful workarounds for this repository

              2. PREPARE: Based on recalled knowledge, identify and prepare for any known issues

              3. EXECUTE: Run the tests with: npm test -- --json --outputFile=test-results.json

              4. ANALYZE: Read test-results.json and analyze which tests passed/failed, durations, and any patterns

              5. LEARN: If you discover NEW insights (failures, patterns, workarounds), store them to memory for future runs

              6. REPORT: Summarize tests executed, learnings applied, and new insights stored

              Repository: ${CIRCLE_PROJECT_REPONAME}
              Branch: ${CIRCLE_BRANCH}
              Build: ${CIRCLE_BUILD_NUM}
            " --local --cwd . --yes

      - store_test_results:
          path: coverage

workflows:
  version: 2

  # Baseline workflow - no intelligence
  baseline:
    jobs:
      - test-baseline

  # Learning workflow - with memory integration
  intelligent-pipeline:
    jobs:
      - test-with-learning:
          context: kubiya-secrets

  # Fully autonomous learning
  autonomous:
    jobs:
      - autonomous-learning-pipeline:
          context: kubiya-secrets
