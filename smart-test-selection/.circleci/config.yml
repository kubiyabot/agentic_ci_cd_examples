version: 2.1

# =============================================================================
# Kubiya Intelligent CI/CD Pipeline - Smart Test Selection
# =============================================================================
#
# This pipeline demonstrates intelligent test selection:
# 1. Clone from public repo: https://github.com/kubiyabot/agentic_ci_cd_examples
# 2. Analyze git diff to see what changed
# 3. Map changes to affected modules
# 4. Run only relevant test suites
# 5. Skip unaffected modules entirely
#
# All kubiya exec commands go through the Control Plane API Gateway
# Zero configuration needed - just set KUBIYA_API_KEY
# =============================================================================

jobs:
  # MECHANICAL APPROACH: Run all tests regardless of changes
  test-mechanical:
    docker:
      - image: cimg/node:20.11
    steps:
      - run:
          name: Clone Repository
          command: |
            git clone https://github.com/kubiyabot/agentic_ci_cd_examples.git repo
            cd repo && git log -1 --oneline

      - run:
          name: Navigate to Smart Test Selection Example
          command: cd repo/smart-test-selection && ls -la

      - restore_cache:
          keys:
            - v1-smart-deps-{{ checksum "repo/smart-test-selection/package.json" }}
            - v1-smart-deps-

      - run:
          name: Install Dependencies
          command: cd repo/smart-test-selection && npm install

      - save_cache:
          paths:
            - repo/smart-test-selection/node_modules
          key: v1-smart-deps-{{ checksum "repo/smart-test-selection/package.json" }}

      - run:
          name: Run ALL Tests (Mechanical Approach)
          command: |
            cd repo/smart-test-selection
            echo "=== MECHANICAL: Running ALL 54 tests ==="
            echo "This runs every test regardless of what changed"
            echo ""
            npm run test:all
            echo ""
            echo "All tests completed (but many were unnecessary)"

      - store_test_results:
          path: repo/smart-test-selection/coverage

  # ==========================================================================
  # INTELLIGENT APPROACH: Kubiya analyzes changes and runs only relevant tests
  # ==========================================================================
  test-intelligent:
    docker:
      - image: cimg/node:20.11
    environment:
      KUBIYA_API_KEY: ${KUBIYA_API_KEY}
      KUBIYA_NON_INTERACTIVE: "true"
    steps:
      - run:
          name: Clone Repository
          command: |
            git clone https://github.com/kubiyabot/agentic_ci_cd_examples.git repo
            cd repo && git log -1 --oneline

      - run:
          name: Navigate to Smart Test Selection Example
          command: cd repo/smart-test-selection && ls -la

      - run:
          name: Fetch git history for diff
          command: |
            cd repo
            git fetch origin main --depth=2 || true

      - restore_cache:
          keys:
            - v1-smart-deps-{{ checksum "repo/smart-test-selection/package.json" }}
            - v1-smart-deps-

      - run:
          name: Install Dependencies
          command: cd repo/smart-test-selection && npm install

      - save_cache:
          paths:
            - repo/smart-test-selection/node_modules
          key: v1-smart-deps-{{ checksum "repo/smart-test-selection/package.json" }}

      - run:
          name: Install Kubiya CLI
          command: |
            curl -fsSL https://raw.githubusercontent.com/kubiyabot/cli/main/install.sh | bash
            echo 'export PATH="$HOME/.kubiya/bin:$PATH"' >> $BASH_ENV

      - run:
          name: Intelligent Test Selection
          command: |
            cd repo/smart-test-selection

            echo "=== KUBIYA INTELLIGENT TEST SELECTION ==="
            echo ""

            kubiya exec "
            You are an intelligent CI/CD agent that runs only relevant tests.

            CONTEXT:
            - Repository: smart-test-selection
            - Working directory: $(pwd)
            - This is a modular Node.js app with independent modules

            MODULE STRUCTURE:
            - src/tasks/ → npm run test:tasks (13 tests - task CRUD operations)
            - src/projects/ → npm run test:projects (17 tests - project management)
            - src/comments/ → npm run test:comments (6 tests - comment management)
            - src/tags/ → npm run test:tags (8 tests - tag management)
            - src/search/ → npm run test:search (10 tests - search & filtering)

            TASK: Analyze changes and run only affected tests

            STEP 1 - Check what changed:
            Run: git diff HEAD~1 --name-only 2>/dev/null || git diff origin/main --name-only 2>/dev/null || echo 'No diff available'

            If no diff available, run all tests.

            STEP 2 - Map changes to modules:
            For each changed file:
            - src/tasks/* → affects 'tasks' module
            - src/projects/* → affects 'projects' module
            - src/comments/* → affects 'comments' module
            - src/tags/* → affects 'tags' module
            - src/search/* → affects 'search' module
            - package.json → affects ALL modules (run all tests)
            - README.md, docs/* → affects NOTHING (skip tests)

            STEP 3 - Execute targeted tests:
            Based on affected modules, run ONLY the affected test commands.
            If multiple modules affected, run each module's tests.
            If only docs changed: echo 'No tests needed'

            STEP 4 - Report efficiency:
            Calculate and report:
            - Total tests in project: 54
            - Tests actually run: X
            - Tests skipped: Y
            - Percentage saved: Z%

            Be efficient - only run what's necessary!
            " --local --cwd $(pwd) --yes

            echo ""
            echo "=== Kubiya execution complete ==="

      - store_test_results:
          path: repo/smart-test-selection/coverage

# =============================================================================
# Workflow Definitions
# =============================================================================
workflows:
  version: 2

  # Compare both approaches
  compare-approaches:
    jobs:
      - test-mechanical:
          name: "Mechanical: All 54 tests"
      - test-intelligent:
          name: "Intelligent: Only relevant tests"
          context:
            - kubiya-secrets

  # Default: Use intelligent approach
  intelligent-testing:
    jobs:
      - test-intelligent:
          context:
            - kubiya-secrets
          filters:
            branches:
              only:
                - main
                - develop

  # Baseline for comparison
  baseline-testing:
    jobs:
      - test-mechanical:
          filters:
            branches:
              only:
                - baseline
